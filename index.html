
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"> 

    <title></title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/offcanvas.css" rel="stylesheet">
    <link href="css/pos.css" rel="stylesheet">
    <link href="css/pad.css" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="ico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="shortcut icon" href="ico/favicon.ico" type="image/x-icon">
    <link rel="icon" href="ico/favicon.ico" type="image/x-icon">
  </head>

  <body>
      
      <nav class="navbar navbar-inverse navbar-fixed-top vis-print">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand sitename vis-print" href="#"></a>
        </div>
        <div id="navbar">
          <form class="navbar-form navbar-right">
            <button class="btn btn-success defaultable vis-print " id="btn_total" data-default="Total: $"></button>
            <button class="btn btn-warning defaultable userinputdefaultable hidden-xs vis-print" id="btn_tendered" data-default="Tendered: $"></button>
            <button class="btn btn-info defaultable userinputdefaultable hidden-xs vis-print" id="btn_change" data-default="Change: $"></button>
            <button class="btn btn-danger hidden-print" id="btn_Clear" onclick="clearAmount();return false;">Clear</button>
            <button class="btn btn-default hidden-print" id="btn_Print" onclick="printRecpt();return false;">Print</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
      
    </nav><!-- /.navbar -->
    
    <div class="visible-xs-block"><p style="height:60px;">&nbsp;</p></div>

    <div class="container">
      <div class="row row-offcanvas row-offcanvas-right">
          
        <div class="col-xs-11 col-sm-8 hidden-print">
          <div class="row" id="inventory"></div><!--/row-->
        </div><!--/.col-xs-12.col-sm-9-->

        <div class="col-xs-7 col-sm-4 sidebar-offcanvas" id="sidebar">
            
            <div class="row hidden-print">
                <div class="list-group" style="margin-left:50px;">
                    <input type="tel" name="name" id="telNumber" class="form-control tel" value="" style="display:none;"/>
                        <div class="num-pad">
                            <div class="span4"><div class="num"><div class="txt">7</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">8</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">9</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">4</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">5</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">6</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">1</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">2</div></div></div>
                            <div class="span4"><div class="num"><div class="txt">3</div></div></div>
                            <div class="span4"><div class="num" data-special="bs" style="background-color:#d9534f;"><div class="txt"><span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></div></div></div>
                            <div class="span4"><div class="num"><div class="txt">0</div></div></div>
                            <div class="span4"><div class="num" data-special="credit"><div class="txt"><span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span></div></div></div>
                            <div class="span4"></div>
                            <div class="span4"><div class="num"><div class="txt">00</div></div></div>
                            <div class="span4"></div>
                        </div>
                </div>
            </div>
            
            <div class="row receiptrow" >
                <h1 class="visible-print" style="margin-top:70px;font-size:26px;margin-left:20px;">Purchased Items:</h1>
                <div class="list-group receiptrow" id="purchasedItemsDiv">
                    <ul id="purchasedItems receiptrow"></ul>
                </div>
            </div>
         
        </div><!--/.sidebar-offcanvas-->
      </div><!--/row-->
      
      <footer class="hidden-print">
        <hr>
        <p class="sitename" style="float:left;"></p>
        <p style="float:right;"><a href="index.html">Register</a> | <a href="history.html">History</a> | <a href="decrypt.html">Admin</a></p>
      </footer>

        <div class="visible-print" style="position:absolute;bottom:60px;width:100%;text-align:center;">
                <center>
                    <span id="eventname" style="font-weight:bold;"></span>
                    <br><span id="website" style="font-weight:bold;"></span>
                    <br><span id="eventdate" style="font-weight:bold;"></span>
                    <br><span id="dt"></span>
                    <br><div id="bc"></div>
                    <br><img src="" id="logo" height="50" />
                </center>
        </div>
        
        <div class="visible-print" style="position:absolute;bottom:10px;width:100%;text-align:center;">
            <p>Recieved By: __________________________________</p>
        </div>

    </div><!--/.container-->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.js"></script>
    <script src="js/jquery-dateFormat.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>
    
    <script src="js/bcmath-min.js"></script>
    <script src="js/pdf417-min.js"></script>
    <script src="js/aes.js"></script>
    <script src="js/fingerprint.js"></script>
    
    <script type="text/javascript">
        var purchased = [];
        var total = 0;
        var change = 0;
        var tendered = 0;
        var menuYear = 0;
        var encKey = "";
        
		function jsonpCallback(json) {   
            menuYear = json.menuyear;
            encKey = json.encKey;
			$.each(json.products, function(i, item) {
                var years = json.products[i].years;
                if(years.indexOf(menuYear) != -1){
                    var id = json.products[i].id;
                    var name = json.products[i].name;
                    var price = json.products[i].price;
                    var itemType = json.products[i].itemType;
                    var html = '<div id="div_'+id+'" class="col-xs-6 col-lg-4 items '+itemType+'" data-price="'+price+'" data-name="'+name+'" onclick="addAmount('+id+');"><h2>'+name+'</h2><p class="squareprice">'+price+'</p></div>'
                    
                    $('#inventory').append(html);
                }
			});
            
            $(".sitename").html(json.sitename);
            $("title").html(json.sitename);
            $('#eventname').html(json.eventname);
            $('#website').html(json.website);
            $('#eventdate').html(json.eventdate);
            $('#logo').attr('src','imgs/'+json.logo);
		}

		function addAmount(id) {
			var amnt = $('#div_'+id).attr("data-price");
			var currAmnt = total * 1;
			var result = currAmnt + amnt*1;

			var name = $('#div_'+id).attr("data-name");

			total = result.toFixed(2);
            
            if (purchased.length == 0 ) {
                purchased.push({"id":id, "name":name,"qty":1,"amt":amnt});
            }
            else 
            {
                var alreadyPurchased = false;
                
                $.each(purchased, function(i, item) {
                    if (item.id == id) {
                        item.qty = (item.qty*1) + 1;
                        alreadyPurchased = true;
                    } 
                });
                
                if (alreadyPurchased == false) {
                        purchased.push({"id":id, "name":name,"qty":1,"amt":amnt});
                }
            }
            
            drawReciept();
            
            if($('#btn_tendered').html().indexOf(".") > - 1) {
                calcChange();
            }
		}
        
        function drawReciept() {
            $('#purchasedItemsDiv').html('<ul id="purchasedItems"></ul>');
            $.each(purchased, function(i, item) {
                $('#purchasedItems').append('<div class="list-group-item"><div class="itemholder"><span class="itemqty">'+item.qty+'x</span> '+item.name+' <div class="itemprice">($'+item.amt+')</div></div></div>');
            });
            
            $('#btn_total').html('Total: $'+total);
        }

		function clearAmount(){
            total = 0;
			$('#purchasedItemsDiv').html('<ul id="purchasedItems"></ul>');
            purchased = [];
            
            
            $.each($('.defaultable'), function(i, item) {
                $(this).html($(this).data('default'));
            });
            
            $('#telNumber').val('');
            
            setTime();
            $('#bc').html(" ");
                 
            return false;
		}
        
        function setTime() {
            $('#dt').html($.format.date(new Date().getTime(), "MM/dd/yyyy HH:mm"));
        }
        
        function calcChange() {
            if($('#telNumber').val() == "credit") {
                $('#btn_change').html('Change: $0.00');
                $('#btn_tendered').html('Tendered: Credit');

                tendered = "Credit";
                change = 0;
            }
            else if($('#telNumber').val() != '') {
                tendered = $('#telNumber').val() * 1;
                tendered = tendered / 100;
                $('#tendered').html(tendered.toFixed(2));
                
                change = ((tendered*1) - (total*1));
                
                $('#btn_change').html('Change: $'+change.toFixed(2));
                $('#btn_tendered').html('Tendered: $'+tendered.toFixed(2));
            }
            else {
                $.each($('.userinputdefaultable'), function(i, item) {
                    $(this).html($(this).data('default'));
                });
            }
        }

        function getEncStr() {
            var o = {};

            o.Fp = "NoFP";
            o.Rc = "NoRc";
            
            var l = jQuery.extend(true, {}, purchased);
            $.each(l, function(i, item) {
                delete item.amt;
                delete item.name;
            });
            
            o.P = l;
            o.Te = tendered;
            o.To = total;
            o.C = change;
            o.Y = menuYear;
            o.D = $('#dt').html();


            if (typeof(Storage) !== "undefined") {
                localStorage.recptCount = (localStorage.recptCount * 1) + 1;
                o.Rc = localStorage.recptCount;
                o.Fp = localStorage.fp;
            }

            var encrypted = CryptoJS.AES.encrypt(JSON.stringify(o), encKey); 
            console.log(encrypted.toString());
            return encrypted.toString();
        }
        
        function genBarCode(encrypted) {
            
            PDF417.init(encrypted);      
            var barcode = PDF417.getBarcodeArray();
            // block sizes (width and height) in pixels
            var bw = 2;
            var bh = 2;
            // create canvas element based on number of columns and rows in barcode
            var container = document.getElementById('bc');
            var canvas = document.createElement('canvas');
            canvas.width = bw * barcode['num_cols'];
            canvas.height = bh * barcode['num_rows'];
            container.appendChild(canvas);
            var ctx = canvas.getContext('2d');                    
            // graph barcode elements
            var y = 0;
            // for each row
            for (var r = 0; r < barcode['num_rows']; ++r) {
                var x = 0;
                // for each column
                for (var c = 0; c < barcode['num_cols']; ++c) {
                    if (barcode['bcode'][r][c] == 1) {                        
                        ctx.fillRect(x, y, bw, bh);
                    }
                    x += bw;
                }
                y += bh;
            }       
        }

        function writeRecptStorage(encStr) {
            if (typeof(Storage) !== "undefined") {
                if(localStorage.recptArr) {
                    var ra = JSON.parse(localStorage.recptArr);
                    ra.push(encStr);
                    localStorage.recptArr = JSON.stringify(ra);
                }
                else {
                    localStorage.recptArr = JSON.stringify([encStr]);
                }
            }
        }
        
        function printRecpt() {
            setTime();
            $('#bc').html(" ");
            var encrypted = getEncStr();
            genBarCode(encrypted);
            writeRecptStorage(encrypted);
            window.print();
        }
        
        $(document).ready(function () {
            $('.num').click(function () {
                var num = $(this);
                var text = $.trim(num.find('.txt').clone().children().remove().end().text());

                if(num.attr("data-special") == "clear") {
                    clearAmount();
                }
                else if(num.attr("data-special") == "bs") {
                    var v = $('#telNumber').val();
                    $('#telNumber').val(v.substring(0, v.length - 1));
                    calcChange();
                }
                else if(num.attr("data-special") == "credit") {
                    $('#telNumber').val('credit');
                    calcChange();
                }
                else {
                    var telNumber = $('#telNumber');
                    if($(telNumber).val().indexOf('credit') !== -1) {
                        $(telNumber).val(text);
                    }
                    else {
                        $(telNumber).val(telNumber.val() + text);
                    }
                    calcChange();
                }

            });
            
            clearAmount();

            if (typeof(Storage) !== "undefined") {
                if(!localStorage.recptCount) {
                    localStorage.recptCount = "1001";
                }
                new Fingerprint2().get(function(result, components){
                        localStorage.fp = result;
                        console.log("Using recpt. ID: " + localStorage.recptCount + " and fingerprint: " + localStorage.fp);
                });
            }

            $(document).keyup(function(e) {
                if (e.keyCode == 27) { 
                    clearAmount();
                }
            });
        });

        
		
	</script>
    
    <script src="products.js" type="text/javascript"></script>
  </body>
</html>
