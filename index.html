<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <meta name="theme-color" content="#333333" />
    <title></title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/offcanvas.css" rel="stylesheet">
    <link href="css/pos.css" rel="stylesheet">
    <link href="css/pad.css" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="ico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="ico/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="ico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="shortcut icon" href="ico/favicon.ico" type="image/x-icon">
    <link rel="icon" href="ico/favicon.ico" type="image/x-icon">
    
</head>

<body>

    <nav class="navbar navbar-inverse navbar-fixed-top vis-print">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand sitename vis-print" href="#"></a>
            </div>
            <div id="navbar">
                <form class="navbar-form navbar-right">
                    <button class="btn btn-success defaultable vis-print " id="btn_total" data-default="Total: $"></button>
                    <button class="btn btn-warning defaultable userinputdefaultable hidden-xs vis-print" id="btn_tendered" data-default="Tendered: $"></button>
                    <button class="btn btn-info defaultable userinputdefaultable hidden-xs vis-print" id="btn_change" data-default="Change: $"></button>
                    <button class="btn btn-danger hidden-print" id="btn_Clear" onclick="clearAmount();return false;"><span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span></button>
                    <button class="btn btn-default hidden-print" id="btn_Save" onclick="saveRecpt();return false;"><span class="glyphicon glyphicon-floppy-saved" aria-hidden="true"></span></button>
                    <button class="btn btn-default hidden-print" id="btn_Print" onclick="printRecpt();return false;"><span class="glyphicon glyphicon-print" aria-hidden="true"></span></button>
                </form>
            </div>
            <!--/.navbar-collapse -->
        </div>

    </nav>
    <!-- /.navbar -->

    <div class="visible-xs-block">
        <p style="height:60px;">&nbsp;</p>
    </div>

    <div class="container">
        <div class="row row-offcanvas row-offcanvas-right">

            <div class="col-xs-12 col-sm-7 col-md-8 hidden-print">
                <div class="row" id="inventorytabs" style="margin-left:-5px;"><ul class="nav nav-tabs" role="tablist" id="inventorytabsul"></div>
                <div class="row tab-content" id="inventory">
                    <div role="tabpanel" class="tab-pane fade in active" id="tab_all"></div>
                </div>
                <!--/row-->
            </div>
            <!--/.col-xs-12.col-sm-9-->

            <div class="col-xs-7 col-sm-5 col-md-4 sidebar-offcanvas" id="sidebar">

                <div class="row hidden-print">
                    <div class="list-group" style="margin-left:5px;margin-right:0px;">
                        <input type="tel" name="name" id="telNumber" class="form-control tel" value="" style="display:none;" />
                        <div class="num-pad">
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">7</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">8</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">9</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">4</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">5</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">6</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">1</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">2</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">3</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num" data-special="bs" style="background-color:#d9534f;">
                                    <div class="txt"><span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span></div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">0</div>
                                </div>
                            </div>
                            <div class="span4">
                                <div class="num" data-special="credit">
                                    <div class="txt"><span class="glyphicon glyphicon-credit-card" aria-hidden="true"></span></div>
                                </div>
                            </div>
                            <div class="span4"></div>
                            <div class="span4">
                                <div class="num">
                                    <div class="txt">00</div>
                                </div>
                            </div>
                            <div class="span4"></div>
                        </div>
                    </div>
                </div>

                <div class="row receiptrow">
                    <h1 class="visible-print" style="margin-top:70px;font-size:26px;margin-left:20px;">Purchased Items:</h1>
                    <div class="list-group receiptrow" id="purchasedItemsDiv">
                        <ul id="purchasedItems receiptrow"></ul>
                    </div>
                </div>

            </div>
            <!--/.sidebar-offcanvas-->
        </div>
        <!--/row-->

        <footer class="hidden-print">
            <hr>
            <p class="sitename" style="float:left;"></p>
            <p style="float:right;"><a href="#myModal" data-toggle="modal" data-target="#myModal">Reprint</a> | <a href="history.html">History</a> | <a href="inventory.html">Inventory</a> | <a href="admin.html">Admin</a></p>
        </footer>

        <div class="visible-print" style="position:absolute;bottom:60px;width:100%;text-align:center;">
            <center>
                <span id="eventname" style="font-weight:bold;"></span>
                <br><span id="website" style="font-weight:bold;"></span>
                <br><span id="eventdate" style="font-weight:bold;"></span>
                <br><span id="dt"></span>
                <br>
                <div id="bc"></div>
                <br><img src="" id="logo" height="50" />
            </center>
        </div>

        <div class="visible-print" style="position:absolute;bottom:10px;width:100%;text-align:center;">
            <p>Recieved By: __________________________________</p>
        </div>

        <div class="modal fade hidden-print" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Reprint Recpt</h4>
                    </div>
                    <div class="modal-body">
                        Old Receipt ID: <input type="text" id="txt_recptID" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="reprintRecpt()">Reprint Reciept</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->

    </div>
    <!--/.container-->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.js"></script>
    <script src="js/jquery-dateFormat.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>

    <script src="js/bcmath-min.js"></script>
    <script src="js/pdf417-min.js"></script>
    <script src="js/aes.js"></script>
    <script src="js/fingerprint.js"></script>

    <script type="text/javascript">
    var purchased = [];
    var total = 0;
    var change = 0;
    var tendered = 0;
    var g_menuYear = 0;
    var g_encKey = "";
    var g_json = "";

    function jsonpCallback(json) {
        g_menuYear = json.menuyear;
        g_encKey = json.encKey;
        g_json = json;

        var tabsArr = [];

        $.each(json.products, function (i, item) {
            var years = json.products[i].years;
            if (years.indexOf(g_menuYear) != -1) {
                
                var id = json.products[i].id;
                var name = json.products[i].name;
                var price = json.products[i].price;
                var itemType = json.products[i].itemType;

                var tabname = "tab_"+itemType;

                if(tabsArr.indexOf(itemType) == -1) {
                    console.log("Creating tab");
                    tabsArr.push(itemType);
                    var liClass = "";
                    
                    $('#inventorytabsul').append('<li role="presentation" class="'+tabname+'" ><a href="#'+tabname+'" aria-controls="'+tabname+'" role="tab" data-toggle="tab">'+capitalize(itemType)+'</a></li>');
                    $('#inventory').append('<div role="tabpanel" class="tab-pane fade in" id="'+tabname+'"></div>');
                }
                
                var special = "";
                if(json.products[i].special) { special = " special"; }
                var html = '<div id="div_' + id + '" class="col-xs-6 col-lg-4 items ' + itemType + special +'" data-price="' + price + '" data-name="' + name + '" onclick="addAmount(' + id + ');"><h2>' + name + '</h2><p class="squareprice">' + price + '</p></div>'

                $('#'+tabname).append(html);
                $('#tab_all').append(html);
            }
        });

        $('#inventorytabsul').append('<li role="presentation" class="tab_all active" ><a href="#tab_all" aria-controls="tab_all" role="tab" data-toggle="tab">All</a></li>');

        $(".sitename").html(json.sitename);
        $("title").html(json.sitename);
        $('#eventname').html(json.eventname);
        $('#website').html(json.website);
        $('#eventdate').html(json.eventdate);
        $('#logo').attr('src', 'imgs/logo_' + g_menuYear + ".png");
    }

    function addAmount(id) {
        var amnt = $('#div_' + id).attr("data-price");
        var currAmnt = total * 1;
        var result = currAmnt + amnt * 1;

        var name = $('#div_' + id).attr("data-name");

        total = result.toFixed(2);

        if (purchased.length == 0) {
            purchased.push({ "id": id, "name": name, "qty": 1, "amt": amnt });
        }
        else {
            var alreadyPurchased = false;

            $.each(purchased, function (i, item) {
                if (item.id == id) {
                    item.qty = (item.qty * 1) + 1;
                    alreadyPurchased = true;
                }
            });

            if (alreadyPurchased == false) {
                purchased.push({ "id": id, "name": name, "qty": 1, "amt": amnt });
            }
        }

        drawReciept();

        if ($('#btn_tendered').html().indexOf(".") > - 1) {
            calcChange();
        }
    }

    function removeme(i) {
        if(purchased[i].qty == 1) {
            purchased.splice(i,1);
        }
        else {
            purchased[i].qty = purchased[i].qty - 1;
        }

        total = 0;
        
        $.each(purchased, function (i, item) {
            var currAmnt = total * 1;
            var result = currAmnt + item.amt * item.qty;

            total = result.toFixed(2);
        });
        if ($('#btn_tendered').html().indexOf(".") > - 1) {
            calcChange();
        }
        drawReciept();
    }

    function drawReciept() {
        $('#purchasedItemsDiv').html('<ul id="purchasedItems"></ul>');
        $.each(purchased, function (i, item) {
            $('#purchasedItems').append('<div class="list-group-item" onclick="removeme('+i+')"><div class="itemholder"><span class="itemqty">' + item.qty + 'x</span> ' + item.name + ' <div class="itemprice">($' + item.amt + ')</div></div></div>');
        });

        $('#btn_total').html('Total: $' + total);
    }

    function clearAmount() {
        total = 0;
        $('#purchasedItemsDiv').html('<ul id="purchasedItems"></ul>');
        purchased = [];


        $.each($('.defaultable'), function (i, item) {
            $(this).html($(this).data('default'));
        });

        $('#telNumber').val('');

        setTime();
        $('#bc').html(" ");

        return false;
    }

    function setTime() {
        $('#dt').html($.format.date(new Date().getTime(), "MM/dd/yyyy HH:mm"));
    }

    function calcChange() {
        if ($('#telNumber').val() == "credit") {
            $('#btn_change').html('Change: $0.00');
            $('#btn_tendered').html('Tendered: Credit');

            tendered = "Credit";
            change = 0;
        }
        else if ($('#telNumber').val() != '') {
            tendered = $('#telNumber').val() * 1;
            tendered = tendered / 100;
            $('#tendered').html(tendered.toFixed(2));

            change = ((tendered * 1) - (total * 1));

            $('#btn_change').html('Change: $' + change.toFixed(2));
            $('#btn_tendered').html('Tendered: $' + tendered.toFixed(2));
        }
        else {
            $.each($('.userinputdefaultable'), function (i, item) {
                $(this).html($(this).data('default'));
            });
        }
    }

    function getEncStr() {
        var o = {};

        o.Fp = "NoFP";
        o.Rc = "NoRc";

        var l = jQuery.extend(true, {}, purchased);
        $.each(l, function (i, item) {
            delete item.amt;
            delete item.name;
        });

        o.P = l;
        o.Te = tendered;
        o.To = total;
        o.C = change;
        o.Y = g_menuYear;
        o.D = $('#dt').html();


        if (typeof (Storage) !== "undefined") {
            localStorage.recptCount = (localStorage.recptCount * 1) + 1;
            o.Rc = localStorage.recptCount;
            o.Fp = localStorage.fp;
        }

        var encrypted = CryptoJS.AES.encrypt(JSON.stringify(o), g_encKey);
        console.log(encrypted.toString());
        return encrypted.toString();
    }

    function genBarCode(encrypted) {

        PDF417.init(encrypted);
        var barcode = PDF417.getBarcodeArray();
        // block sizes (width and height) in pixels
        var bw = 2;
        var bh = 2;
        // create canvas element based on number of columns and rows in barcode
        var container = document.getElementById('bc');
        var canvas = document.createElement('canvas');
        canvas.width = bw * barcode['num_cols'];
        canvas.height = bh * barcode['num_rows'];
        container.appendChild(canvas);
        var ctx = canvas.getContext('2d');
        // graph barcode elements
        var y = 0;
        // for each row
        for (var r = 0; r < barcode['num_rows']; ++r) {
            var x = 0;
            // for each column
            for (var c = 0; c < barcode['num_cols']; ++c) {
                if (barcode['bcode'][r][c] == 1) {
                    ctx.fillRect(x, y, bw, bh);
                }
                x += bw;
            }
            y += bh;
        }
    }

    function writeRecptStorage(encStr) {
        if (typeof (Storage) !== "undefined") {
            if (localStorage.recptArr) {
                var ra = JSON.parse(localStorage.recptArr);
                ra.push(encStr);
                localStorage.recptArr = JSON.stringify(ra);
            }
            else {
                localStorage.recptArr = JSON.stringify([encStr]);
            }

            try {
                $.post( "save.php", { recid: localStorage.recptCount, register: localStorage.fp, encText: encStr } );
            } catch(err) {
                console.log(err);
            }
            
        }
    }

    function getPT(enc) {
        var pt = CryptoJS.AES.decrypt(enc, g_encKey);
        return pt.toString(CryptoJS.enc.Utf8);
    }

    function printRecpt() {
        setTime();
        $('#bc').html(" ");
        var encrypted = getEncStr();
        genBarCode(encrypted);
        writeRecptStorage(encrypted);
        window.print();
    }

    function reprintRecpt() {
        $('#dt').html();
        $('#bc').html(" ");
        var encrypted = "";
        var encIndex = -1;

        $('#purchasedItemsDiv').html('<ul id="purchasedItems"></ul>');

        var ra = JSON.parse(localStorage.recptArr);

        $.each(ra, function (i, recpt) {
            var pt = getPT(recpt);
            var j = JSON.parse(pt);
            if (j.Rc == $("#txt_recptID").val()) {
                encIndex = i;
                $('#logo').attr('src', 'imgs/logo_' + j.Y + ".png");
                $('#dt').html(j.D);
                $('#btn_change').html('Change: $' + j.C);
                $('#btn_tendered').html('Tendered: $' + j.Te);
                $('#btn_total').html('Tendered: $' + j.To);

                $('#purchasedItems').append('<div class="list-group-item"><div class="itemholder"><b><i>REPRINT REPRINT REPRINT REPRINT REPRINT REPRINT</i></b></div></div>');

                var l = jQuery.extend(true, {}, j.P);
                $.each(l, function (i, item) {
                    var inventoryItem = $.grep(g_json.products, function (e) { return e.id == item.id; });
                    var ii = inventoryItem[0];
                    $('#purchasedItems').append('<div class="list-group-item"><div class="itemholder"><span class="itemqty">' + item.qty + 'x</span> ' + ii.name + ' <div class="itemprice">($' + ii.price + ')</div></div></div>');
                });

            }
        });

        if (encIndex > -1) {
            genBarCode(ra[encIndex]);
            setTimeout(function(){ window.print(); }, 500); // take a sec to load new graphics
        }
        else {
            alert("That ID doesn't exist!");
        }
    }

    function saveRecpt() {
        setTime();
        var encrypted = getEncStr();
        writeRecptStorage(encrypted);
        alert("Saved Receipt!");
    }

    function capitalize(string) {
        if(string.length > 2) { 
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        else {
            return string.toUpperCase();
        }
    }

    $(document).ready(function () {
        $('.num').click(function () {
            var num = $(this);
            var text = $.trim(num.find('.txt').clone().children().remove().end().text());

            if (num.attr("data-special") == "clear") {
                clearAmount();
            }
            else if (num.attr("data-special") == "bs") {
                var v = $('#telNumber').val();
                $('#telNumber').val(v.substring(0, v.length - 1));
                calcChange();
            }
            else if (num.attr("data-special") == "credit") {
                $('#telNumber').val('credit');
                calcChange();
            }
            else {
                var telNumber = $('#telNumber');
                if ($(telNumber).val().indexOf('credit') !== -1) {
                    $(telNumber).val(text);
                }
                else {
                    $(telNumber).val(telNumber.val() + text);
                }
                calcChange();
            }

        });

        $('.defaultable').click(function() { return false; });

        clearAmount();

        if (typeof (Storage) !== "undefined") {
            if (!localStorage.recptCount) {
                localStorage.recptCount = "1001";
            }
            new Fingerprint2().get(function (result, components) {
                localStorage.fp = result;
                console.log("Using recpt. ID: " + localStorage.recptCount + " and fingerprint: " + localStorage.fp);
            });
        }

        $(document).keyup(function (e) {
            if (e.keyCode == 27) {
                clearAmount();
            }
        });
    });
    </script>

    <script src="products.js" type="text/javascript"></script>
</body>

</html>